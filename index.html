<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CRM Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container { 
      max-width: 1400px;
      margin: auto;
    }
    .header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 25px 30px;
      border-radius: 16px;
      margin-bottom: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .logo {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 24px;
    }
    .header-title {
      flex: 1;
    }
    .header-title h1 {
      font-size: 24px;
      color: #2d3748;
      margin-bottom: 4px;
    }
    .header-title p {
      font-size: 13px;
      color: #718096;
    }
    .tabs {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }
    .tab {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 20px;
      border-radius: 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
      border: 2px solid transparent;
    }
    .tab:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    }
    .tab.active {
      border-color: #667eea;
    }
    .tab-icon {
      font-size: 32px;
      margin-bottom: 10px;
    }
    .tab-title {
      font-size: 14px;
      font-weight: 600;
      color: #2d3748;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .tab-blue .tab-icon { color: #2563eb; }
    .tab-green .tab-icon { color: #059669; }
    .tab-orange .tab-icon { color: #ea580c; }
    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px;
    }
    .card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 25px;
      border-radius: 16px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
      transition: all 0.3s ease;
    }
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .card-title {
      font-size: 13px;
      font-weight: 600;
      color: #718096;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .card-icon {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }
    .icon-blue { background: #e0e7ff; color: #2563eb; }
    .icon-green { background: #d1fae5; color: #059669; }
    .icon-orange { background: #fed7aa; color: #ea580c; }
    .icon-purple { background: #e9d5ff; color: #9333ea; }
    .big-number {
      font-size: 48px;
      font-weight: 700;
      color: #1a202c;
      margin-bottom: 8px;
      line-height: 1;
    }
    .metric-label {
      font-size: 13px;
      color: #718096;
      margin-bottom: 4px;
    }
    .metric-value {
      font-size: 18px;
      font-weight: 600;
      color: #2d3748;
    }
    .chart-wrapper {
      margin-top: 20px;
      height: 200px;
    }
    .mini-chart {
      height: 80px;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-top: 20px;
    }
    .stat-box {
      padding: 15px;
      background: #f7fafc;
      border-radius: 10px;
      border-left: 4px solid #667eea;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th {
      text-align: left;
      padding: 12px 8px;
      font-size: 11px;
      font-weight: 600;
      color: #718096;
      text-transform: uppercase;
      border-bottom: 2px solid #e2e8f0;
      letter-spacing: 0.5px;
    }
    td {
      padding: 14px 8px;
      color: #2d3748;
      border-bottom: 1px solid #f1f5f9;
      font-size: 14px;
    }
    tr:last-child td {
      border-bottom: none;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: white;
      font-size: 18px;
    }
    .footer {
      margin-top: 20px;
      text-align: center;
      color: rgba(255, 255, 255, 0.9);
      font-size: 13px;
      padding: 20px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 16px;
    }
    .progress-bar {
      height: 8px;
      background: #e2e8f0;
      border-radius: 10px;
      overflow: hidden;
      margin-top: 8px;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      border-radius: 10px;
      transition: width 1s ease;
    }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="logo">üìä</div>
    <div class="header-title">
      <h1>CRM Dashboard</h1>
      <p>Manuel V. Gallego Foundation Colleges Inc.</p>
    </div>
    <div style="text-align: right;">
      <div style="font-size: 12px; color: #718096;">Last Updated</div>
      <div style="font-size: 14px; font-weight: 600; color: #2d3748;" id="lastUpdate">-</div>
    </div>
  </div>

  <div class="tabs">
    <div class="tab tab-blue active">
      <div class="tab-icon">üéØ</div>
      <div class="tab-title">Presales</div>
    </div>
    <div class="tab tab-green">
      <div class="tab-icon">üí∞</div>
      <div class="tab-title">After Sales</div>
    </div>
    <div class="tab tab-orange">
      <div class="tab-icon">üìã</div>
      <div class="tab-title">Survey</div>
    </div>
  </div>

  <div id="loadingMsg" class="loading">‚è≥ Loading data from Google Sheets...</div>

  <div class="dashboard" id="dashboard" style="display: none;">
    <!-- Leads Card -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">Total Leads</div>
        <div class="card-icon icon-blue">üìà</div>
      </div>
      <div class="big-number" id="leads">0</div>
      <div class="metric-label">Active leads in pipeline</div>
      <div class="chart-wrapper mini-chart">
        <canvas id="leadsChart"></canvas>
      </div>
    </div>

    <!-- Campaign Performance -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">Campaign Performance</div>
        <div class="card-icon icon-purple">üé™</div>
      </div>
      <div class="stats-grid">
        <div class="stat-box">
          <div class="metric-label">Field Campaign</div>
          <div class="metric-value" id="fieldCampaign">0</div>
          <div class="progress-bar">
            <div class="progress-fill" id="fieldProgress" style="width: 0%"></div>
          </div>
        </div>
        <div class="stat-box" style="border-left-color: #059669;">
          <div class="metric-label">Via Jotform</div>
          <div class="metric-value" id="jotform">0</div>
          <div class="progress-bar">
            <div class="progress-fill" id="jotformProgress" style="width: 0%; background: linear-gradient(90deg, #059669 0%, #10b981 100%);"></div>
          </div>
        </div>
      </div>
      <div class="chart-wrapper mini-chart">
        <canvas id="campaignChart"></canvas>
      </div>
    </div>

    <!-- Outbound Calls -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">Total Outbound Calls</div>
        <div class="card-icon icon-green">üìû</div>
      </div>
      <div class="big-number" id="totalCalls">0</div>
      <div class="metric-label">Calls made this period</div>
      <div class="chart-wrapper">
        <canvas id="callsChart"></canvas>
      </div>
    </div>

    <!-- Commits vs Converts -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">Conversion Tracking</div>
        <div class="card-icon icon-orange">üéØ</div>
      </div>
      <div class="stats-grid">
        <div class="stat-box">
          <div class="metric-label">Commits</div>
          <div class="metric-value" id="commits">0</div>
        </div>
        <div class="stat-box" style="border-left-color: #ea580c;">
          <div class="metric-label">Actual Converts</div>
          <div class="metric-value" id="converts">0</div>
        </div>
      </div>
      <div class="chart-wrapper mini-chart">
        <canvas id="conversionChart"></canvas>
      </div>
    </div>

    <!-- Payment Status -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">After Sales Metrics</div>
        <div class="card-icon icon-green">üí≥</div>
      </div>
      <div style="margin-bottom: 15px;">
        <div class="metric-label">Leads for Payable</div>
        <div class="metric-value" id="leadsPayable">0</div>
      </div>
      <div style="margin-bottom: 15px;">
        <div class="metric-label">Payment Commits</div>
        <div class="metric-value" id="paymentCommits">0</div>
      </div>
      <div>
        <div class="metric-label">Actual Paid</div>
        <div class="metric-value" id="actualPaid">0</div>
        <div class="progress-bar">
          <div class="progress-fill" id="paidProgress" style="width: 0%; background: linear-gradient(90deg, #059669 0%, #10b981 100%);"></div>
        </div>
      </div>
    </div>

    <!-- Customer Support -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">Customer Support</div>
        <div class="card-icon icon-blue">üéß</div>
      </div>
      <div class="stats-grid">
        <div class="stat-box">
          <div class="metric-label">Complaints</div>
          <div class="metric-value" id="complaints">0</div>
        </div>
        <div class="stat-box" style="border-left-color: #059669;">
          <div class="metric-label">Issues Resolved</div>
          <div class="metric-value" id="issuesResolved">0</div>
        </div>
      </div>
      <div style="margin-top: 15px;">
        <div class="metric-label">High Satisfaction Rate</div>
        <div class="metric-value" id="satisfaction">0%</div>
        <div class="progress-bar">
          <div class="progress-fill" id="satisfactionProgress" style="width: 0%"></div>
        </div>
      </div>
    </div>

    <!-- Survey Results -->
    <div class="card" style="grid-column: span 2;">
      <div class="card-header">
        <div class="card-title">Survey Participants by School</div>
        <div class="card-icon icon-orange">üè´</div>
      </div>
      <table id="surveyTable">
        <thead>
          <tr>
            <th>School</th>
            <th>Participants</th>
            <th>Week</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Survey Chart -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">Participants Distribution</div>
        <div class="card-icon icon-purple">üìä</div>
      </div>
      <div class="chart-wrapper">
        <canvas id="surveyChart"></canvas>
      </div>
    </div>
  </div>

  <div class="footer">
    <strong>CRM Dashboard</strong> ‚Ä¢ Powered by Google Sheets ‚Ä¢ Data updates in real-time
  </div>
</div>

<script>
const sheetId = "1xHp0FDSAfhHU97PAMk9k0bORvlFjtP_MO2k8wLtmjBk";

function gvizUrl(sheetName) {
  return `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${sheetName}`;
}

async function fetchSheet(url) {
  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error("Network error");
    const text = await res.text();
    const jsonStr = text.substring(text.indexOf("{"), text.lastIndexOf("}") + 1);
    const json = JSON.parse(jsonStr);
    return json.table.rows || [];
  } catch (err) {
    console.error("Fetch failed:", err);
    return [];
  }
}

async function loadData() {
  const presales = await fetchSheet(gvizUrl("PRESALES"));
  const aftersales = await fetchSheet(gvizUrl("AFTERSALES"));
  const survey = await fetchSheet(gvizUrl("SURVEY"));

  console.log("Presales:", presales);
  console.log("Aftersales:", aftersales);
  console.log("Survey:", survey);

  return {
    // Presales data (row 2, index 1)
    leads: presales[1]?.c?.[0]?.v || 0,
    fieldCampaign: presales[1]?.c?.[1]?.v || 0,
    jotform: presales[1]?.c?.[2]?.v || 0,
    totalOutbound: presales[1]?.c?.[3]?.v || 0,
    commits: presales[1]?.c?.[4]?.v || 0,
    converts: presales[1]?.c?.[5]?.v || 0,
    
    // Aftersales data (row 2, index 1)
    leadsPayable: aftersales[1]?.c?.[0]?.v || 0,
    totalOutboundAfter: aftersales[1]?.c?.[1]?.v || 0,
    paymentCommits: aftersales[1]?.c?.[2]?.v || 0,
    actualPaid: aftersales[1]?.c?.[3]?.v || 0,
    complaints: aftersales[1]?.c?.[4]?.v || 0,
    issuesResolved: aftersales[1]?.c?.[5]?.v || 0,
    satisfaction: aftersales[1]?.c?.[6]?.v || 0,
    
    // Survey data (starting from row 2)
    survey: survey.slice(1).map(r => ({
      school: r.c?.[0]?.v || "",
      participants: r.c?.[1]?.v || 0,
      week: r.c?.[2]?.v || 0
    })).filter(s => s.school)
  };
}

Chart.defaults.font.family = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
Chart.defaults.color = "#718096";

loadData().then(data => {
  document.getElementById("loadingMsg").style.display = "none";
  document.getElementById("dashboard").style.display = "grid";

  // Update all values
  document.getElementById("leads").textContent = data.leads.toLocaleString();
  document.getElementById("fieldCampaign").textContent = data.fieldCampaign.toLocaleString();
  document.getElementById("jotform").textContent = data.jotform.toLocaleString();
  document.getElementById("totalCalls").textContent = data.totalOutbound.toLocaleString();
  document.getElementById("commits").textContent = data.commits.toLocaleString();
  document.getElementById("converts").textContent = data.converts.toLocaleString();
  document.getElementById("leadsPayable").textContent = data.leadsPayable.toLocaleString();
  document.getElementById("paymentCommits").textContent = data.paymentCommits.toLocaleString();
  document.getElementById("actualPaid").textContent = data.actualPaid.toLocaleString();
  document.getElementById("complaints").textContent = data.complaints.toLocaleString();
  document.getElementById("issuesResolved").textContent = data.issuesResolved.toLocaleString();
  document.getElementById("satisfaction").textContent = data.satisfaction + "%";

  // Progress bars
  const totalCampaign = data.fieldCampaign + data.jotform;
  document.getElementById("fieldProgress").style.width = ((data.fieldCampaign / totalCampaign) * 100) + "%";
  document.getElementById("jotformProgress").style.width = ((data.jotform / totalCampaign) * 100) + "%";
  
  const paidPercent = data.paymentCommits > 0 ? (data.actualPaid / data.paymentCommits) * 100 : 0;
  document.getElementById("paidProgress").style.width = paidPercent + "%";
  document.getElementById("satisfactionProgress").style.width = data.satisfaction + "%";

  // Survey table
  const tbody = document.querySelector("#surveyTable tbody");
  data.survey.forEach(s => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${s.school}</td><td><strong>${s.participants}</strong></td><td>${s.week}</td>`;
    tbody.appendChild(tr);
  });

  // Leads Trend Chart
  new Chart(document.getElementById("leadsChart"), {
    type: "line",
    data: {
      labels: ["Jan", "Feb", "Mar", "Apr", "May"],
      datasets: [{
        data: [data.leads * 0.6, data.leads * 0.75, data.leads * 0.85, data.leads * 0.95, data.leads],
        borderColor: "#2563eb",
        backgroundColor: "rgba(37, 99, 235, 0.1)",
        fill: true,
        tension: 0.4,
        borderWidth: 2,
        pointRadius: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { display: false },
        x: { display: false }
      }
    }
  });

  // Campaign Donut
  new Chart(document.getElementById("campaignChart"), {
    type: "doughnut",
    data: {
      labels: ["Field", "Jotform"],
      datasets: [{
        data: [data.fieldCampaign, data.jotform],
        backgroundColor: ["#667eea", "#059669"],
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: "70%",
      plugins: { legend: { display: false } }
    }
  });

  // Calls Line Chart
  new Chart(document.getElementById("callsChart"), {
    type: "line",
    data: {
      labels: ["Week 1", "Week 2", "Week 3", "Week 4", "Week 5"],
      datasets: [{
        data: [
          data.totalOutbound * 0.15,
          data.totalOutbound * 0.35,
          data.totalOutbound * 0.55,
          data.totalOutbound * 0.80,
          data.totalOutbound
        ],
        borderColor: "#059669",
        backgroundColor: "rgba(5, 150, 105, 0.1)",
        fill: true,
        tension: 0.4,
        borderWidth: 3,
        pointRadius: 5,
        pointBackgroundColor: "#059669"
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { 
          beginAtZero: true,
          grid: { color: "#f1f5f9" },
          ticks: { font: { size: 11 } }
        },
        x: { 
          grid: { display: false },
          ticks: { font: { size: 11 } }
        }
      }
    }
  });

  // Conversion Bar
  new Chart(document.getElementById("conversionChart"), {
    type: "bar",
    data: {
      labels: ["Commits", "Converts"],
      datasets: [{
        data: [data.commits, data.converts],
        backgroundColor: ["#667eea", "#ea580c"],
        borderRadius: 8
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { display: false },
        x: { 
          grid: { display: false },
          ticks: { font: { size: 11 } }
        }
      }
    }
  });

  // Survey Bar Chart
  new Chart(document.getElementById("surveyChart"), {
    type: "bar",
    data: {
      labels: data.survey.map(s => s.school),
      datasets: [{
        data: data.survey.map(s => s.participants),
        backgroundColor: "#ea580c",
        borderRadius: 8
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { 
          beginAtZero: true,
          grid: { color: "#f1f5f9" },
          ticks: { font: { size: 11 } }
        },
        x: { 
          grid: { display: false },
          ticks: { font: { size: 10 } }
        }
      }
    }
  });

  // Update timestamp
  const now = new Date();
  document.getElementById("lastUpdate").textContent = now.toLocaleTimeString();
}).catch(err => {
  document.getElementById("loadingMsg").innerHTML = "‚ùå Error loading data<br>Please check Google Sheet permissions";
  console.error("Error:", err);
});
</script>
</body>
</html>

