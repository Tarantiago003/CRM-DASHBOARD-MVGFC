<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CRM Dashboard - Manuel V. Gallego Foundation Colleges Inc.</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1e5631 0%, #2d7a4a 50%, #1e5631 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container { 
      max-width: 1400px;
      margin: auto;
    }
    .header {
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(10px);
      padding: 25px 30px;
      border-radius: 16px;
      margin-bottom: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      gap: 15px;
      border-top: 4px solid #f4c430;
    }
    .logo {
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #1e5631 0%, #2d7a4a 100%);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 28px;
      border: 3px solid #f4c430;
    }
    .header-title {
      flex: 1;
    }
    .header-title h1 {
      font-size: 24px;
      color: #1e5631;
      margin-bottom: 4px;
      font-weight: 700;
    }
    .header-title p {
      font-size: 13px;
      color: #2d7a4a;
      font-weight: 600;
    }
    .tabs {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }
    .tab {
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(10px);
      padding: 20px;
      border-radius: 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      border: 2px solid transparent;
    }
    .tab:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      border-color: #f4c430;
    }
    .tab.active {
      border-color: #1e5631;
      background: rgba(30, 86, 49, 0.05);
    }
    .tab-icon {
      font-size: 32px;
      margin-bottom: 10px;
    }
    .tab-title {
      font-size: 14px;
      font-weight: 600;
      color: #2d3748;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .tab-green .tab-icon { color: #1e5631; }
    .tab-gold .tab-icon { color: #f4c430; }
    .tab-blue .tab-icon { color: #1e5ba8; }
    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px;
    }
    .card {
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(10px);
      padding: 25px;
      border-radius: 16px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      border-top: 4px solid #1e5631;
    }
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .card-title {
      font-size: 13px;
      font-weight: 600;
      color: #718096;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .card-icon {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }
    .icon-green { background: #d4edda; color: #1e5631; }
    .icon-gold { background: #fff3cd; color: #f4c430; }
    .icon-blue { background: #cce5ff; color: #1e5ba8; }
    .icon-red { background: #f8d7da; color: #c82333; }
    .big-number {
      font-size: 48px;
      font-weight: 700;
      color: #1e5631;
      margin-bottom: 8px;
      line-height: 1;
    }
    .metric-label {
      font-size: 13px;
      color: #718096;
      margin-bottom: 4px;
    }
    .metric-value {
      font-size: 18px;
      font-weight: 600;
      color: #1e5631;
    }
    .chart-wrapper {
      margin-top: 20px;
      height: 200px;
    }
    .mini-chart {
      height: 80px;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-top: 20px;
    }
    .stat-box {
      padding: 15px;
      background: #f0f7f4;
      border-radius: 10px;
      border-left: 4px solid #1e5631;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th {
      text-align: left;
      padding: 12px 8px;
      font-size: 11px;
      font-weight: 600;
      color: #1e5631;
      text-transform: uppercase;
      border-bottom: 2px solid #1e5631;
      letter-spacing: 0.5px;
      background: #f0f7f4;
    }
    td {
      padding: 14px 8px;
      color: #2d3748;
      border-bottom: 1px solid #e2e8f0;
      font-size: 14px;
    }
    tr:last-child td {
      border-bottom: none;
    }
    tr:hover {
      background: #f9fafb;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: white;
      font-size: 18px;
    }
    .footer {
      margin-top: 20px;
      text-align: center;
      color: rgba(255, 255, 255, 0.95);
      font-size: 13px;
      padding: 20px;
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      border-top: 3px solid #f4c430;
    }
    .progress-bar {
      height: 8px;
      background: #e2e8f0;
      border-radius: 10px;
      overflow: hidden;
      margin-top: 8px;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #1e5631 0%, #2d7a4a 100%);
      border-radius: 10px;
      transition: width 1s ease;
    }
    .progress-gold {
      background: linear-gradient(90deg, #f4c430 0%, #ffdb58 100%);
    }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="logo">üéì</div>
    <div class="header-title">
      <h1>CRM Dashboard</h1>
      <p>Manuel V. Gallego Foundation Colleges Inc.</p>
    </div>
    <div style="text-align: right;">
      <div style="font-size: 12px; color: #718096;">Last Updated</div>
      <div style="font-size: 14px; font-weight: 600; color: #1e5631;" id="lastUpdate">-</div>
    </div>
  </div>

  <div class="tabs">
    <div class="tab tab-gold">
      <div class="tab-icon">üéØ</div>
      <div class="tab-title">Presales</div>
    </div>
    <div class="tab tab-gold">
      <div class="tab-icon">üí∞</div>
      <div class="tab-title">After Sales</div>
    </div>
    <div class="tab tab-blue">
      <div class="tab-icon">üìã</div>
      <div class="tab-title">Survey</div>
    </div>
  </div>

  <div id="loadingMsg" class="loading">‚è≥ Loading data from Google Sheets...</div>

  <div class="dashboard" id="dashboard" style="display: none;">
    <!-- Leads Card -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">Total Leads</div>
        <div class="card-icon icon-green">üìà</div>
      </div>
      <div class="big-number" id="leads">0</div>
      <div class="metric-label">Active leads in pipeline</div>
      <div class="chart-wrapper mini-chart">
        <canvas id="leadsChart"></canvas>
      </div>
    </div>

    <!-- Campaign Performance -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">Campaign Performance</div>
        <div class="card-icon icon-gold">üé™</div>
      </div>
      <div class="stats-grid">
        <div class="stat-box">
          <div class="metric-label">Field Campaign</div>
          <div class="metric-value" id="fieldCampaign">0</div>
          <div class="progress-bar">
            <div class="progress-fill" id="fieldProgress" style="width: 0%"></div>
          </div>
        </div>
        <div class="stat-box" style="border-left-color: #f4c430;">
          <div class="metric-label">Via Jotform</div>
          <div class="metric-value" id="jotform">0</div>
          <div class="progress-bar">
            <div class="progress-fill progress-gold" id="jotformProgress" style="width: 0%;"></div>
          </div>
        </div>
      </div>
      <div class="chart-wrapper mini-chart">
        <canvas id="campaignChart"></canvas>
      </div>
    </div>

    <!-- Outbound Calls -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">Total Outbound Calls</div>
        <div class="card-icon icon-blue">üìû</div>
      </div>
      <div class="big-number" id="totalCalls">0</div>
      <div class="metric-label">Calls made this period</div>
      <div class="chart-wrapper">
        <canvas id="callsChart"></canvas>
      </div>
    </div>

    <!-- Commits vs Converts -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">Conversion Tracking</div>
        <div class="card-icon icon-gold">üéØ</div>
      </div>
      <div class="stats-grid">
        <div class="stat-box">
          <div class="metric-label">Commits</div>
          <div class="metric-value" id="commits">0</div>
        </div>
        <div class="stat-box" style="border-left-color: #f4c430;">
          <div class="metric-label">Actual Converts</div>
          <div class="metric-value" id="converts">0</div>
        </div>
      </div>
      <div class="chart-wrapper mini-chart">
        <canvas id="conversionChart"></canvas>
      </div>
    </div>

    <!-- Payment Status -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">After Sales Metrics</div>
        <div class="card-icon icon-green">üí≥</div>
      </div>
      <div style="margin-bottom: 15px;">
        <div class="metric-label">Leads for Payable</div>
        <div class="metric-value" id="leadsPayable">0</div>
      </div>
      <div style="margin-bottom: 15px;">
        <div class="metric-label">Payment Commits</div>
        <div class="metric-value" id="paymentCommits">0</div>
      </div>
      <div>
        <div class="metric-label">Actual Paid</div>
        <div class="metric-value" id="actualPaid">0</div>
        <div class="progress-bar">
          <div class="progress-fill" id="paidProgress" style="width: 0%;"></div>
        </div>
      </div>
    </div>

    <!-- Customer Support -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">Customer Support</div>
        <div class="card-icon icon-blue">üéß</div>
      </div>
      <div class="stats-grid">
        <div class="stat-box" style="border-left-color: #c82333; background: #fff5f5;">
          <div class="metric-label">Complaints</div>
          <div class="metric-value" style="color: #c82333;" id="complaints">0</div>
        </div>
        <div class="stat-box" style="border-left-color: #1e5631;">
          <div class="metric-label">Issues Resolved</div>
          <div class="metric-value" id="issuesResolved">0</div>
        </div>
      </div>
      <div style="margin-top: 15px;">
        <div class="metric-label">High Satisfaction Rate</div>
        <div class="metric-value" id="satisfaction">0%</div>
        <div class="progress-bar">
          <div class="progress-fill" id="satisfactionProgress" style="width: 0%"></div>
        </div>
      </div>
    </div>

    <!-- Survey Results -->
    <div class="card" style="grid-column: span 2;">
      <div class="card-header">
        <div class="card-title">Survey Participants by School</div>
        <div class="card-icon icon-gold">üè´</div>
      </div>
      <table id="surveyTable">
        <thead>
          <tr>
            <th>School</th>
            <th>Participants</th>
            <th>Week</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Survey Chart -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">Participants Distribution</div>
        <div class="card-icon icon-green">üìä</div>
      </div>
      <div class="chart-wrapper">
        <canvas id="surveyChart"></canvas>
      </div>
    </div>
  </div>

  <div class="footer">
    <strong>Manuel V. Gallego Foundation Colleges Inc.</strong> ‚Ä¢ Cabanatuan City, Philippines ‚Ä¢ Est. 1963
  </div>
</div>

<script>
const sheetId = "1xHp0FDSAfhHU97PAMk9k0bORvlFjtP_MO2k8wLtmjBk";

function gvizUrl(sheetName) {
  return `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${sheetName}`;
}

async function fetchSheet(url) {
  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error("Network error");
    const text = await res.text();
    const jsonStr = text.substring(text.indexOf("{"), text.lastIndexOf("}") + 1);
    const json = JSON.parse(jsonStr);
    return json.table.rows || [];
  } catch (err) {
    console.error("Fetch failed:", err);
    return [];
  }
}

async function loadData() {
  const presales = await fetchSheet(gvizUrl("PRESALES"));
  const aftersales = await fetchSheet(gvizUrl("AFTERSALES"));
  const survey = await fetchSheet(gvizUrl("SURVEY"));

  console.log("=== RAW DATA FROM GOOGLE SHEETS ===");
  console.log("Presales rows:", presales);
  console.log("Aftersales rows:", aftersales);
  console.log("Survey rows:", survey);

  // Get the LAST row with data (most recent entry)
  const presalesData = presales.filter(r => r.c?.[0]?.v && typeof r.c[0].v === 'number');
  const aftersalesData = aftersales.filter(r => r.c?.[0]?.v && typeof r.c[0].v === 'number');
  
  // Use the LAST data row (most recent)
  const latestPresales = presalesData[presalesData.length - 1];
  const latestAftersales = aftersalesData[aftersalesData.length - 1];
  
  console.log("=== LATEST DATA EXTRACTED ===");
  console.log("Latest Presales:", latestPresales);
  console.log("Latest Aftersales:", latestAftersales);

  return {
    // Presales data - LATEST ROW
    leads: latestPresales?.c?.[0]?.v || 0,
    fieldCampaign: latestPresales?.c?.[1]?.v || 0,
    jotform: latestPresales?.c?.[2]?.v || 0,
    totalOutbound: latestPresales?.c?.[3]?.v || 0,
    commits: latestPresales?.c?.[4]?.v || 0,
    converts: latestPresales?.c?.[5]?.v || 0,
    
    // Aftersales data - LATEST ROW
    leadsPayable: latestAftersales?.c?.[0]?.v || 0,
    totalOutboundAfter: latestAftersales?.c?.[1]?.v || 0,
    paymentCommits: latestAftersales?.c?.[2]?.v || 0,
    actualPaid: latestAftersales?.c?.[3]?.v || 0,
    complaints: latestAftersales?.c?.[4]?.v || 0,
    issuesResolved: latestAftersales?.c?.[5]?.v || 0,
    satisfaction: latestAftersales?.c?.[6]?.v || 0,
    
    // Survey data - ALL ROWS (skip header)
    survey: survey.slice(1).map(r => ({
      school: r.c?.[0]?.v || "",
      participants: r.c?.[1]?.v || 0,
      week: r.c?.[2]?.v || 0
    })).filter(s => s.school && s.participants),
    
    // Historical data for charts (all rows)
    presalesHistory: presalesData,
    aftersalesHistory: aftersalesData
  };
}

Chart.defaults.font.family = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
Chart.defaults.color = "#718096";

loadData().then(data => {
  console.log("=== FINAL PROCESSED DATA ===");
  console.log(data);

  document.getElementById("loadingMsg").style.display = "none";
  document.getElementById("dashboard").style.display = "grid";

  // Update all values
  document.getElementById("leads").textContent = data.leads.toLocaleString();
  document.getElementById("fieldCampaign").textContent = data.fieldCampaign.toLocaleString();
  document.getElementById("jotform").textContent = data.jotform.toLocaleString();
  document.getElementById("totalCalls").textContent = data.totalOutbound.toLocaleString();
  document.getElementById("commits").textContent = data.commits.toLocaleString();
  document.getElementById("converts").textContent = data.converts.toLocaleString();
  document.getElementById("leadsPayable").textContent = data.leadsPayable.toLocaleString();
  document.getElementById("paymentCommits").textContent = data.paymentCommits.toLocaleString();
  document.getElementById("actualPaid").textContent = data.actualPaid.toLocaleString();
  document.getElementById("complaints").textContent = data.complaints.toLocaleString();
  document.getElementById("issuesResolved").textContent = data.issuesResolved.toLocaleString();
  document.getElementById("satisfaction").textContent = data.satisfaction + "%";

  // Progress bars
  const totalCampaign = data.fieldCampaign + data.jotform;
  if (totalCampaign > 0) {
    document.getElementById("fieldProgress").style.width = ((data.fieldCampaign / totalCampaign) * 100) + "%";
    document.getElementById("jotformProgress").style.width = ((data.jotform / totalCampaign) * 100) + "%";
  }
  
  const paidPercent = data.paymentCommits > 0 ? (data.actualPaid / data.paymentCommits) * 100 : 0;
  document.getElementById("paidProgress").style.width = Math.min(paidPercent, 100) + "%";
  document.getElementById("satisfactionProgress").style.width = data.satisfaction + "%";

  // Survey table
  const tbody = document.querySelector("#surveyTable tbody");
  if (data.survey.length > 0) {
    data.survey.forEach(s => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td><strong>${s.school}</strong></td><td>${s.participants}</td><td>Week ${s.week}</td>`;
      tbody.appendChild(tr);
    });
  } else {
    tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #718096;">No survey data available</td></tr>';
  }

  // Leads Trend Chart - using historical data if available
  const leadsHistory = data.presalesHistory.map(r => r.c?.[0]?.v || 0);
  new Chart(document.getElementById("leadsChart"), {
    type: "line",
    data: {
      labels: leadsHistory.map((_, i) => `Entry ${i + 1}`),
      datasets: [{
        data: leadsHistory.length > 0 ? leadsHistory : [data.leads],
        borderColor: "#1e5631",
        backgroundColor: "rgba(30, 86, 49, 0.1)",
        fill: true,
        tension: 0.4,
        borderWidth: 2,
        pointRadius: 3,
        pointBackgroundColor: "#1e5631"
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { display: false },
        x: { display: false }
      }
    }
  });

  // Campaign Donut
  new Chart(document.getElementById("campaignChart"), {
    type: "doughnut",
    data: {
      labels: ["Field Campaign", "Via Jotform"],
      datasets: [{
        data: [data.fieldCampaign || 1, data.jotform || 1],
        backgroundColor: ["#1e5631", "#f4c430"],
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: "70%",
      plugins: { 
        legend: { 
          display: true,
          position: 'bottom',
          labels: { font: { size: 10 } }
        } 
      }
    }
  });

  // Calls Line Chart - using historical outbound calls
  const callsHistory = data.presalesHistory.map(r => r.c?.[3]?.v || 0);
  new Chart(document.getElementById("callsChart"), {
    type: "line",
    data: {
      labels: callsHistory.map((_, i) => `Period ${i + 1}`),
      datasets: [{
        data: callsHistory.length > 0 ? callsHistory : [data.totalOutbound],
        borderColor: "#1e5ba8",
        backgroundColor: "rgba(30, 91, 168, 0.1)",
        fill: true,
        tension: 0.4,
        borderWidth: 3,
        pointRadius: 5,
        pointBackgroundColor: "#1e5ba8"
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { 
          beginAtZero: true,
          grid: { color: "#f1f5f9" },
          ticks: { font: { size: 11 } }
        },
        x: { 
          grid: { display: false },
          ticks: { font: { size: 11 } }
        }
      }
    }
  });

  // Conversion Bar
  new Chart(document.getElementById("conversionChart"), {
    type: "bar",
    data: {
      labels: ["Commits", "Converts"],
      datasets: [{
        data: [data.commits || 0, data.converts || 0],
        backgroundColor: ["#1e5631", "#f4c430"],
        borderRadius: 8
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { 
          beginAtZero: true,
          grid: { color: "#f1f5f9" }
        },
        x: { 
          grid: { display: false },
          ticks: { font: { size: 11 } }
        }
      }
    }
  });

  // Survey Bar Chart
  if (data.survey.length > 0) {
    new Chart(document.getElementById("surveyChart"), {
      type: "bar",
      data: {
        labels: data.survey.map(s => s.school),
        datasets: [{
          data: data.survey.map(s => s.participants),
          backgroundColor: "#f4c430",
          borderRadius: 8
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          y: { 
            beginAtZero: true,
            grid: { color: "#f1f5f9" },
            ticks: { font: { size: 11 } }
          },
          x: { 
            grid: { display: false },
            ticks: { font: { size: 10 } }
          }
        }
      }
    });
  }

  // Update timestamp
  const now = new Date();
  const options = { 
    month: 'short', 
    day: 'numeric', 
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  };
  document.getElementById("lastUpdate").textContent = now.toLocaleString('en-US', options);
}).catch(err => {
  document.getElementById("loadingMsg").innerHTML = "‚ùå Error loading data<br><small>Please check Google Sheet permissions</small>";
  console.error("Error:", err);
});
</script>
</body>
</html>

