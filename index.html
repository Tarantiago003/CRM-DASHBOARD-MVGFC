<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sales & Operations Overview</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: #e8ecf1;
      padding: 30px 20px;
    }
    .container { 
      max-width: 1200px;
      margin: auto;
      background: #fff;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }
    .header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 25px;
      padding-bottom: 20px;
      border-bottom: 2px solid #f0f0f0;
    }
    .logo {
      width: 45px;
      height: 45px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 8px;
    }
    .title {
      font-size: 18px;
      font-weight: 600;
      color: #2d3748;
      letter-spacing: 0.5px;
    }
    .tabs {
      display: flex;
      gap: 15px;
      margin-bottom: 25px;
    }
    .tab {
      flex: 1;
      padding: 14px;
      text-align: center;
      color: #fff;
      font-weight: 600;
      font-size: 13px;
      border-radius: 8px;
      letter-spacing: 0.5px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .tab:hover { transform: translateY(-2px); }
    .tab-blue { background: #2563eb; }
    .tab-green { background: #059669; }
    .tab-orange { background: #ea580c; }
    .grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
    }
    .card {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    }
    .card h3 {
      font-size: 12px;
      font-weight: 600;
      color: #6b7280;
      margin-bottom: 15px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .big-number {
      font-size: 42px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 15px;
    }
    .chart-container {
      position: relative;
      height: 180px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    th {
      text-align: left;
      padding: 10px 8px;
      font-size: 11px;
      font-weight: 600;
      color: #6b7280;
      text-transform: uppercase;
      border-bottom: 2px solid #e5e7eb;
    }
    td {
      padding: 12px 8px;
      color: #374151;
      border-bottom: 1px solid #f3f4f6;
    }
    .gauge-container {
      position: relative;
      height: 150px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .gauge-value {
      font-size: 32px;
      font-weight: 700;
      color: #1f2937;
      margin-top: 10px;
    }
    .footer {
      text-align: center;
      margin-top: 25px;
      padding-top: 20px;
      border-top: 1px solid #e5e7eb;
      font-size: 11px;
      color: #9ca3af;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      color: #6b7280;
      margin-top: 8px;
    }
    .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 3px;
    }
    .loading {
      text-align: center;
      padding: 20px;
      color: #6b7280;
    }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="logo"></div>
    <div class="title">SALES & OPERATIONS OVERVIEW</div>
  </div>

  <div class="tabs">
    <div class="tab tab-blue">PRESALES</div>
    <div class="tab tab-green">AFTER SALES</div>
    <div class="tab tab-orange">SURVEY</div>
  </div>

  <div id="loadingMsg" class="loading">Loading data from Google Sheets...</div>

  <div class="grid" id="dashboardGrid" style="display: none;">
    <!-- Number of Leads Card -->
    <div class="card">
      <h3>Number of Leads</h3>
      <div class="big-number" id="leads">0</div>
      <div style="display: flex; gap: 15px;">
        <div style="flex: 1;">
          <div style="font-size: 11px; color: #6b7280; margin-bottom: 8px;">CAMPAIGN SOURCE</div>
          <canvas id="campaignChart" style="max-height: 100px;"></canvas>
        </div>
        <div style="flex: 1;">
          <div style="font-size: 11px; color: #6b7280; margin-bottom: 8px;">COMMIT VS CONVERT</div>
          <canvas id="convertChart" style="max-height: 100px;"></canvas>
          <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 11px;">
            <div>
              <div style="color: #6b7280;">FIELD</div>
              <div style="font-weight: 600; color: #1f2937;" id="fieldPercent">0%</div>
            </div>
            <div>
              <div style="color: #6b7280;">ONLINE</div>
              <div style="font-weight: 600; color: #1f2937;" id="onlineCount">0</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Payment Conversion Card -->
    <div class="card">
      <h3>Payment Conversion</h3>
      <div class="big-number" id="paymentConv">0%</div>
      <div style="font-size: 11px; color: #6b7280; margin-bottom: 10px;">CUSTOMER SERVICE</div>
      <div class="gauge-container" style="height: 100px;">
        <canvas id="gaugeChart"></canvas>
      </div>
      <div style="margin-top: 15px; font-size: 11px; color: #6b7280;">HIGH SATISFACTION FEEDBACK</div>
      <div style="display: flex; gap: 8px; margin-top: 8px;">
        <div style="flex: 1;">
          <div class="legend-item">
            <div class="legend-color" style="background: #ea580c;"></div>
            <span>ISSUES</span>
          </div>
        </div>
        <div style="flex: 1;">
          <div class="legend-item">
            <div class="legend-color" style="background: #06b6d4;"></div>
            <span>RESOLVED</span>
          </div>
        </div>
        <div style="flex: 1;">
          <div class="legend-item">
            <div class="legend-color" style="background: #8b5cf6;"></div>
            <span>COMPLAINTS</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Survey Participants Card -->
    <div class="card">
      <h3>Survey Participants</h3>
      <table id="surveyTable">
        <tr><th>School</th><th>Participants</th><th>Week</th></tr>
      </table>
    </div>

    <!-- Total Outbound Calls Card -->
    <div class="card">
      <h3>Total Outbound Calls</h3>
      <div class="chart-container">
        <canvas id="lineChart"></canvas>
      </div>
      <div style="text-align: right; margin-top: 10px;">
        <div style="font-size: 24px; font-weight: 700; color: #1f2937;" id="totalCalls">0</div>
      </div>
    </div>

    <!-- Customer Service Gauge Card -->
    <div class="card">
      <h3>Customer Service</h3>
      <div class="gauge-container">
        <canvas id="donutChart"></canvas>
        <div class="gauge-value" id="csPercent">0%</div>
      </div>
      <div style="text-align: right; margin-top: 10px;">
        <div style="font-size: 11px; color: #6b7280;">TOTAL OUTBOUND</div>
        <div style="font-size: 18px; font-weight: 600; color: #1f2937;" id="totalOutbound">0</div>
      </div>
    </div>

    <!-- Participants by School Card -->
    <div class="card">
      <h3>Participants by School</h3>
      <div class="chart-container">
        <canvas id="barChart"></canvas>
      </div>
    </div>
  </div>

  <div class="footer">
    Data last updated: <span id="lastUpdate">-</span>
  </div>
</div>

<script>
const sheetId = "1xHp0FDSAfhHU97PAMk9k0bORvlFjtP_MO2k8wLtmjBk";
const sheetTabs = {
  telemarketing: "Telemarketing",
  collections: "Collections",
  survey: "Survey"
};

function gvizUrl(sheetName) {
  return `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${sheetName}`;
}

async function fetchSheet(url) {
  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error("Network issue");
    const text = await res.text();
    const jsonStr = text.substring(text.indexOf("{"), text.lastIndexOf("}") + 1);
    const json = JSON.parse(jsonStr);
    return json.table.rows || [];
  } catch (err) {
    console.error("Fetch failed:", url, err);
    return [];
  }
}

async function loadData() {
  const tele = await fetchSheet(gvizUrl(sheetTabs.telemarketing));
  const coll = await fetchSheet(gvizUrl(sheetTabs.collections));
  const surv = await fetchSheet(gvizUrl(sheetTabs.survey));

  console.log("Telemarketing data:", tele);
  console.log("Collections data:", coll);
  console.log("Survey data:", surv);

  return {
    leads: tele[0]?.c?.[0]?.v || 0,
    campaignSource: {
      field: tele[0]?.c?.[1]?.v || 0,
      online: tele[0]?.c?.[2]?.v || 0
    },
    commitConvert: {
      commit: tele[0]?.c?.[3]?.v || 0,
      convert: tele[0]?.c?.[4]?.v || 0
    },
    paymentConv: coll[0]?.c?.[0]?.v || 0,
    customerService: coll[0]?.c?.[1]?.v || 0,
    outboundCalls: tele.slice(1, 6).map(r => r.c?.[0]?.v || 0),
    totalOutbound: coll[0]?.c?.[2]?.v || 0,
    surveyTable: surv.map(r => r.c.map(c => c?.v || "")),
    participantsBySchool: surv.map(r => ({
      school: r.c?.[0]?.v || "",
      count: r.c?.[1]?.v || 0
    }))
  };
}

Chart.defaults.font.family = "-apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif";
Chart.defaults.color = "#6b7280";

loadData().then(data => {
  // Hide loading, show dashboard
  document.getElementById("loadingMsg").style.display = "none";
  document.getElementById("dashboardGrid").style.display = "grid";

  // Update all dynamic values from Google Sheets
  document.getElementById("leads").textContent = data.leads.toLocaleString();
  document.getElementById("paymentConv").textContent = data.paymentConv + "%";
  document.getElementById("csPercent").textContent = data.customerService + "%";
  
  // Calculate total calls from outbound array
  const totalCalls = data.outboundCalls.reduce((a, b) => a + b, 0);
  document.getElementById("totalCalls").textContent = totalCalls.toLocaleString();
  document.getElementById("totalOutbound").textContent = data.totalOutbound.toLocaleString();

  // Campaign source percentages
  const totalCampaign = data.campaignSource.field + data.campaignSource.online;
  const fieldPercent = totalCampaign > 0 ? ((data.campaignSource.field / totalCampaign) * 100).toFixed(1) : 0;
  document.getElementById("fieldPercent").textContent = fieldPercent + "%";
  document.getElementById("onlineCount").textContent = data.campaignSource.online;

  // Survey table - populate from Google Sheets
  const surveyTable = document.getElementById("surveyTable");
  data.surveyTable.forEach(row => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${row[0]}</td><td>${row[1]}</td><td>${row[2]}</td>`;
    surveyTable.appendChild(tr);
  });

  // Campaign Source Donut - using real data
  new Chart(document.getElementById("campaignChart"), {
    type: "doughnut",
    data: {
      labels: ["Field", "Online"],
      datasets: [{
        data: [data.campaignSource.field, data.campaignSource.online],
        backgroundColor: ["#2563eb", "#06b6d4"],
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: "70%",
      plugins: {
        legend: { display: false }
      }
    }
  });

  // Commit vs Convert Bar - using real data
  new Chart(document.getElementById("convertChart"), {
    type: "bar",
    data: {
      labels: ["Commit", "Convert"],
      datasets: [{
        data: [data.commitConvert.commit, data.commitConvert.convert],
        backgroundColor: ["#10b981", "#3b82f6"],
        borderRadius: 4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      indexAxis: "y",
      plugins: { legend: { display: false } },
      scales: {
        x: { display: false },
        y: { display: false }
      }
    }
  });

  // Gauge Chart - using real data
  new Chart(document.getElementById("gaugeChart"), {
    type: "doughnut",
    data: {
      datasets: [{
        data: [data.customerService, 100 - data.customerService],
        backgroundColor: ["#ea580c", "#e5e7eb"],
        borderWidth: 0,
        circumference: 180,
        rotation: 270
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: "75%",
      plugins: { legend: { display: false } }
    }
  });

  // Line Chart - using real outbound calls data
  new Chart(document.getElementById("lineChart"), {
    type: "line",
    data: {
      labels: ["Week 1", "Week 2", "Week 3", "Week 4", "Week 5"],
      datasets: [{
        data: data.outboundCalls,
        borderColor: "#2563eb",
        backgroundColor: "rgba(37, 99, 235, 0.1)",
        fill: true,
        tension: 0.4,
        borderWidth: 2,
        pointRadius: 4,
        pointBackgroundColor: "#2563eb"
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { 
          beginAtZero: true,
          grid: { color: "#f3f4f6" },
          ticks: { font: { size: 10 } }
        },
        x: { 
          grid: { display: false },
          ticks: { font: { size: 10 } }
        }
      }
    }
  });

  // Donut Chart - using real customer service data
  new Chart(document.getElementById("donutChart"), {
    type: "doughnut",
    data: {
      datasets: [{
        data: [data.customerService, 100 - data.customerService],
        backgroundColor: ["#ea580c", "#06b6d4"],
        borderWidth: 0,
        circumference: 180,
        rotation: 270
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: "75%",
      plugins: { legend: { display: false } }
    }
  });

  // Bar Chart - using real participants by school data
  const schoolLabels = data.participantsBySchool.map(s => s.school);
  const schoolCounts = data.participantsBySchool.map(s => s.count);
  
  new Chart(document.getElementById("barChart"), {
    type: "bar",
    data: {
      labels: schoolLabels,
      datasets: [{
        data: schoolCounts,
        backgroundColor: "#ea580c",
        borderRadius: 6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { 
          beginAtZero: true,
          grid: { color: "#f3f4f6" },
          ticks: { font: { size: 10 } }
        },
        x: { 
          grid: { display: false },
          ticks: { font: { size: 10 } }
        }
      }
    }
  });

  // Update timestamp
  document.getElementById("lastUpdate").textContent = new Date().toLocaleString();
}).catch(err => {
  document.getElementById("loadingMsg").textContent = "Error loading data. Please check your Google Sheet permissions.";
  console.error("Error:", err);
});
</script>
</body>
</html>
